{
  "project": "office2pdf",
  "branchName": "ralph/phase7-fixture-fixes",
  "description": "Phase 7: Fix 14 fixture conversion failures across 5 root causes",
  "userStories": [
    {
      "id": "US-070",
      "title": "Replace rgba() with rgb() in Typst codegen",
      "description": "Typst has no `rgba()` function. It uses `rgb(r, g, b, a)` with 4 arguments for colors with alpha. Currently `write_shadow_shape()` (line 309) and `write_fill_color()` (line 326) in `crates/office2pdf/src/render/typst_gen.rs` emit `rgba(...)` which causes 'unknown variable: rgba' errors.\n\nFix:\n- Line 309 (`write_shadow_shape`): change format string from `rgba({}, {}, {}, {})` to `rgb({}, {}, {}, {})`\n- Line 326 (`write_fill_color`): change format string from `rgba({}, {}, {}, {})` to `rgb({}, {}, {}, {})`\n- Update doc comment on line 320 from 'rgba' to 'rgb'\n- Update ALL existing unit tests that assert `rgba(` to assert `rgb(` with 4 args instead. Search for 'rgba' in the test module.\n\nAffected fixture files: `10-slides.pptx`, `45545_Comment.pptx`, `customGeo.pptx`",
      "acceptanceCriteria": [
        "write_shadow_shape() emits rgb() not rgba() for shadow colors",
        "write_fill_color() emits rgb() not rgba() for colors with opacity",
        "Doc comment on write_fill_color updated to say rgb not rgba",
        "All existing tests that checked for rgba(...) are updated to check for rgb(...) with 4 args",
        "cargo test --workspace passes",
        "cargo fmt --all -- --check passes",
        "cargo clippy --workspace -- -D warnings passes",
        "Verify: cargo run -p office2pdf-cli -- tests/fixtures/pptx/10-slides.pptx -o /tmp/test.pdf succeeds"
      ],
      "priority": 1,
      "passes": false,
      "notes": "This is purely a string replacement: rgba -> rgb in format strings and test assertions. Typst's rgb() accepts 3 args (r,g,b) OR 4 args (r,g,b,a). There are ~6 test assertions that reference 'rgba' that need updating."
    },
    {
      "id": "US-071",
      "title": "Fix nested list double-content-block in Typst codegen",
      "description": "In `generate_list_items()` in `crates/office2pdf/src/render/typst_gen.rs` (lines 668-701), when a list item has nested children, the code emits TWO content blocks on `list.item`/`enum.item`:\n\nCurrent (WRONG): `list.item[text][#list(...)]` — two `[...]` blocks = two body arguments\nCorrect: `list.item[text #list(...)]` — single content block with nested list inside\n\nThe bug: Line 676 closes `]` for the item text, then line 687 opens another `[` for the nested list. Typst's `list.item`/`enum.item` only accepts ONE body argument.\n\nFix in `generate_list_items()`:\n- When nested items exist (lines 685-696), do NOT close the first `]` before emitting the nested list. Instead, emit the nested `#list(...)` or `#enum(...)` INSIDE the same content block.\n- Change flow: open `[`, write text content, if nested: write ` #func(nested...)`, then close `]`.\n- Specifically: remove the `out.push(']')` at line 676 and move it after the nested block emission. The line 687 `[` and line 695 `]` around the nested list should be removed.\n\nAffected fixture files: `ComplexNumberedLists.docx`, `numberings.docx`, `unit_test_formatting.docx`, `unit_test_lists.docx`",
      "acceptanceCriteria": [
        "generate_list_items() emits single content block per list item (no double [...])",
        "Nested sub-lists are embedded inside the parent item's content block",
        "Output for nested list: list.item[text #list(...)] not list.item[text][#list(...)]",
        "Add unit test: nested list generates single content block",
        "cargo test --workspace passes",
        "cargo fmt --all -- --check passes",
        "cargo clippy --workspace -- -D warnings passes",
        "Verify: cargo run -p office2pdf-cli -- tests/fixtures/docx/numberings.docx -o /tmp/test.pdf succeeds"
      ],
      "priority": 2,
      "passes": false,
      "notes": "The key insight: `list.item[body]` takes exactly one positional (body) argument. Two `[...]` blocks means two positional args which Typst rejects as 'unexpected argument'. The fix is to keep the content block open while emitting nested lists."
    },
    {
      "id": "US-072",
      "title": "Clamp colspan to prevent exceeding table columns",
      "description": "In `generate_table()` in `crates/office2pdf/src/render/typst_gen.rs` (line 718+), table cells with `col_span` values that exceed the available columns cause Typst error: 'cell's colspan would cause it to exceed the available column(s)'.\n\nThe parsers (DOCX and PPTX) set `col_span` from XML `gridSpan` without validating against the actual column count. The codegen passes it through unchecked.\n\nFix in `generate_table()` (around line 718):\n1. Calculate `num_cols` from `table.column_widths.len()`. If `column_widths` is empty, infer from the maximum number of cells in any row.\n2. Before rendering rows, iterate through rows and cells, tracking column position. For each cell, clamp its effective `col_span` to `min(cell.col_span, num_cols - current_col_pos)`. Ensure it's at least 1.\n3. Pass the clamped colspan to `generate_table_cell()` or modify the cell rendering to use the clamped value.\n\nAlternatively, modify `write_cell_params()` to accept a clamped colspan parameter, or clamp inside `generate_table()` before calling `generate_table_cell()`.\n\nAffected fixture files: `drawing.docx`, `powerpoint_sample.pptx`, `shapes.pptx`, `table_test2.pptx`",
      "acceptanceCriteria": [
        "Table cells with colspan exceeding column count are clamped to remaining columns",
        "Column position is tracked per row to correctly calculate remaining columns",
        "num_cols is derived from column_widths.len() or inferred from row cell counts",
        "Clamped colspan is at least 1",
        "Add unit test: table with colspan exceeding columns is clamped correctly",
        "cargo test --workspace passes",
        "cargo fmt --all -- --check passes",
        "cargo clippy --workspace -- -D warnings passes",
        "Verify: cargo run -p office2pdf-cli -- tests/fixtures/docx/drawing.docx -o /tmp/test.pdf succeeds"
      ],
      "priority": 3,
      "passes": false,
      "notes": "The clamping should happen in codegen (typst_gen.rs) as a safety net, not in the parser. This way even if parsers emit bad data, the codegen won't crash. Look at generate_table() and generate_table_cell() — you may need to pass the clamped col_span as a parameter or create a wrapper."
    },
    {
      "id": "US-073",
      "title": "Sort gradient stops by position before rendering",
      "description": "In `write_gradient_fill()` in `crates/office2pdf/src/render/typst_gen.rs` (line 360), gradient stops are iterated in parser order without sorting. Typst requires gradient stop offsets to be in monotonic (non-decreasing) order, otherwise it errors: 'offsets must be in monotonic order'.\n\nFix in `write_gradient_fill()` (line 360):\n- Before iterating `gradient.stops`, clone and sort the stops by their `position` field.\n- Use `let mut sorted_stops = gradient.stops.clone(); sorted_stops.sort_by(|a, b| a.position.partial_cmp(&b.position).unwrap_or(std::cmp::Ordering::Equal));`\n- Then iterate `sorted_stops` instead of `gradient.stops`.\n\nPrefer sorting in codegen rather than parser as a safety net.\n\nAffected fixture file: `backgrounds.pptx`",
      "acceptanceCriteria": [
        "write_gradient_fill() sorts stops by position before rendering",
        "Unsorted gradient stops from parser are handled correctly",
        "Add unit test: gradient with unsorted stops renders in sorted order",
        "cargo test --workspace passes",
        "cargo fmt --all -- --check passes",
        "cargo clippy --workspace -- -D warnings passes",
        "Verify: cargo run -p office2pdf-cli -- tests/fixtures/pptx/backgrounds.pptx -o /tmp/test.pdf succeeds"
      ],
      "priority": 4,
      "passes": false,
      "notes": "The GradientStop struct has a `position: f64` field. Sort by this before generating the Typst gradient.linear() call. The GradientFill and GradientStop types are in ir/ module — check if they derive Clone. If not, you'll need to collect into a new Vec of references and sort that."
    },
    {
      "id": "US-074",
      "title": "Map Unicode math symbols to Typst identifiers in OMML parser",
      "description": "In `parse_math_run()` in `crates/office2pdf/src/parser/omml.rs` (line 286-310), raw Unicode text is appended directly to the output. Greek letters like `π` are not recognized by Typst as math identifiers, causing 'unknown variable: πr' errors.\n\nFix in `parse_math_run()`:\n- After reading text content (line 297-299), add a post-processing step that:\n  1. Maps Unicode Greek letters to Typst math identifiers: π→pi, α→alpha, β→beta, γ→gamma, δ→delta, ε→epsilon, ζ→zeta, η→eta, θ→theta, ι→iota, κ→kappa, λ→lambda, μ→mu, ν→nu, ξ→xi, ο→omicron, ρ→rho, σ→sigma, τ→tau, υ→upsilon, φ→phi, χ→chi, ψ→psi, ω→omega (and uppercase variants: Α→Alpha, Β→Beta, Γ→Gamma, Δ→Delta, etc.)\n  2. Also map common math symbols: ∞→infinity, ∂→partial, ∇→nabla, ±→plus.minus, ×→times, ÷→div, ≤→lt.eq, ≥→gt.eq, ≠→eq.not, ≈→approx, ∈→in, ∉→in.not, ⊂→subset, ⊃→supset, ∪→union, ∩→sect, ∅→emptyset\n  3. Insert space between adjacent identifiers to enable implicit multiplication (e.g., `πr` → `pi r`)\n\nCreate a helper function `map_math_text(input: &str) -> String` that processes the text character by character.\n\nAffected fixture file: `equations.docx`",
      "acceptanceCriteria": [
        "Unicode Greek letters in math runs are mapped to Typst identifiers (π→pi, α→alpha, etc.)",
        "Common Unicode math symbols are mapped to Typst equivalents",
        "Adjacent identifiers have spaces inserted for implicit multiplication",
        "Plain ASCII letters and digits pass through unchanged",
        "Add unit test: parse_math_run maps π to pi, πr² to pi r 2 (or similar)",
        "Add unit test for map_math_text helper function with various Greek letters and symbols",
        "cargo test --workspace passes",
        "cargo fmt --all -- --check passes",
        "cargo clippy --workspace -- -D warnings passes",
        "Verify: cargo run -p office2pdf-cli -- tests/fixtures/docx/equations.docx -o /tmp/test.pdf succeeds"
      ],
      "priority": 5,
      "passes": false,
      "notes": "The mapping function should handle multi-byte Unicode characters properly. Process the input string character by character using .chars(). When a character maps to a named identifier, output the name. When transitioning between identifiers (e.g., 'pi' followed by 'r'), insert a space. Numbers and operators (+, -, =, etc.) should pass through as-is. The function should be robust — unknown Unicode chars can pass through unchanged."
    },
    {
      "id": "US-075",
      "title": "Remove corrupt deep-table-cell.docx fixture",
      "description": "The file `tests/fixtures/docx/deep-table-cell.docx` is a corrupt ZIP file that always fails with 'Failed to read from zip'. This is not a bug in our code — the file itself is damaged. Remove it and all references.\n\nChanges needed:\n1. Delete `tests/fixtures/docx/deep-table-cell.docx`\n2. Remove the test line `docx_fixture_tests!(deep_table_cell, \"deep-table-cell.docx\");` from `crates/office2pdf/tests/docx_fixtures.rs`\n3. Remove `- \\`docx/deep-table-cell.docx\\`` from `tests/fixtures/THIRD-PARTY-LICENSES.md`",
      "acceptanceCriteria": [
        "tests/fixtures/docx/deep-table-cell.docx is deleted",
        "docx_fixtures.rs no longer references deep-table-cell.docx",
        "THIRD-PARTY-LICENSES.md no longer references deep-table-cell.docx",
        "cargo test --workspace passes",
        "cargo fmt --all -- --check passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Simple cleanup task. Delete the file and remove 2 lines from 2 files. Use git rm for the fixture file so git tracks the deletion."
    }
  ]
}
